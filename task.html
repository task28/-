<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Daily Task</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); font-family: 'Poppins', sans-serif; color: white; padding: 20px; }
        .glass-box {
            background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(15px);
            padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px;
        }
        h2 { text-align: center; margin-bottom: 20px; }
        
        /* Data Row */
        .data-row {
            background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin: 8px 0;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 13px; border: 1px solid rgba(255,255,255,0.05);
        }
        .data-row strong { color: #00c6ff; margin-right: 5px; }
        .copy-btn {
            background: rgba(0, 198, 255, 0.2); color: #00c6ff; padding: 5px 10px;
            border-radius: 5px; cursor: pointer; font-size: 12px; transition: 0.2s;
        }
        .copy-btn:active { background: #00c6ff; color: white; }

        /* Buttons */
        button {
            width: 100%; padding: 12px; border-radius: 30px; border: none;
            background: linear-gradient(to right, #00c6ff, #0072ff);
            color: white; font-weight: bold; cursor: pointer; margin-top: 15px;
            transition: 0.3s;
        }
        button:disabled { 
            background: #555; 
            cursor: not-allowed; 
            opacity: 0.7;
        }
        
        /* File Input */
        .file-upload { display: block; margin-top: 15px; }
        .file-upload label {
            display: flex; justify-content: center; align-items: center; gap: 10px;
            padding: 15px; background: rgba(0,198,255,0.1);
            border: 1px dashed #00c6ff; border-radius: 10px; cursor: pointer; transition: 0.3s;
        }
        .file-upload label.uploaded {
            background: rgba(40, 167, 69, 0.2); border: 1px solid #28a745; color: #28a745; pointer-events: none;
        }
        input[type="file"] { display: none; }
    </style>
</head>
<body>
    <h2>Premium Task</h2>
    
    <!-- APPLY SECTION -->
    <div id="applySection" class="glass-box">
        <h3><i class="fas fa-briefcase"></i> Apply for Task</h3>
        <p>You can apply once every <strong>2 Hours</strong>.</p>
        
        <button id="applyBtn" onclick="applyTask()">APPLY NOW</button>
        
        <!-- Error/Cooldown Message -->
        <div id="cooldownMsg" style="background: rgba(255, 0, 0, 0.2); padding: 10px; border-radius: 5px; margin-top: 10px; border: 1px solid red; display: none;">
            <i class="fas fa-clock"></i> Please wait <span id="timeLeft" style="font-weight:bold;"></span> before next task.
        </div>
    </div>

    <!-- TASK SECTION (Hidden initially) -->
    <div id="taskSection" class="glass-box" style="display:none;">
        <h3><i class="fas fa-spinner fa-spin"></i> Task In Progress</h3>
        <div id="statusMsg" style="color: #f0ad4e; margin: 10px 0;">Wait for Admin to assign details...</div>
        
        <div id="adminDetails" class="details" style="display:none;">
            <!-- Copy Data Rows -->
            <div class="data-row"><span><strong>F.Name:</strong> <span id="t_fname"></span></span> <i class="fas fa-copy copy-btn" onclick="copyText('t_fname')"></i></div>
            <div class="data-row"><span><strong>L.Name:</strong> <span id="t_lname"></span></span> <i class="fas fa-copy copy-btn" onclick="copyText('t_lname')"></i></div>
            <div class="data-row"><span><strong>Gmail:</strong> <span id="t_gmail"></span></span> <i class="fas fa-copy copy-btn" onclick="copyText('t_gmail')"></i></div>
            <div class="data-row"><span><strong>Pass:</strong> <span id="t_pass"></span></span> <i class="fas fa-copy copy-btn" onclick="copyText('t_pass')"></i></div>
            <div class="data-row"><span><strong>Rec:</strong> <span id="t_rec"></span></span> <i class="fas fa-copy copy-btn" onclick="copyText('t_rec')"></i></div>
            
            <p style="color:#ff4b5c; text-align:center; margin-top:10px;"><strong>Time Limit:</strong> <span id="t_time"></span></p>
            
            <!-- Uploads -->
            <div class="file-upload"><input type="file" id="ss1" accept="image/*" onchange="handleFileSelect('ss1', 'lbl_ss1')"><label for="ss1" id="lbl_ss1"><i class="fas fa-camera"></i> Screenshot 1</label></div>
            <div class="file-upload"><input type="file" id="ss2" accept="image/*" onchange="handleFileSelect('ss2', 'lbl_ss2')"><label for="ss2" id="lbl_ss2"><i class="fas fa-camera"></i> Screenshot 2</label></div>

            <button id="submitBtn" onclick="submitTask()">SUBMIT PROOF</button>
        </div>
    </div>
    
    <button onclick="window.location.href='home.html'" style="background: #333;">BACK HOME</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getDatabase, ref, push, onValue, update, get, child } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyAvTnq3h4SAsgOZcKg58TioELMZWr-Jp4c", authDomain: "task-d0f72.firebaseapp.com", databaseURL: "https://task-d0f72-default-rtdb.firebaseio.com", projectId: "task-d0f72", storageBucket: "task-d0f72.firebasestorage.app", messagingSenderId: "376760667912", appId: "1:376760667912:web:056595289880d291d5a6bd" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        let currentTaskId = null;

        onAuthStateChanged(auth, (user) => {
            if(user) checkActiveTask(user.uid);
        });

        // 1. MAIN CHECK LOGIC
        function checkActiveTask(uid) {
            onValue(ref(db, 'tasks'), (snapshot) => {
                let hasActive = false;
                snapshot.forEach(child => {
                    const t = child.val();
                    // Check if user has ANY pending or ongoing task
                    if(t.uid === uid && (t.status === 'pending' || t.status === 'assigned' || t.status === 'submitted')) {
                        hasActive = true;
                        currentTaskId = child.key;
                        showTaskUI(t);
                    }
                });
                
                // If no active task, check for Cooldown
                if(!hasActive) {
                    document.getElementById('applySection').style.display = 'block';
                    document.getElementById('taskSection').style.display = 'none';
                    checkCooldown(uid);
                }
            });
        }

        // 2. COOLDOWN CHECKER (Visual)
        function checkCooldown(uid) {
            get(child(ref(db), `users/${uid}/lastTaskTime`)).then((snap) => {
                if(snap.exists()){
                    const diff = Date.now() - snap.val();
                    const waitTime = 7200000; // 2 Hours in Milliseconds
                    
                    if(diff < waitTime) {
                        // Disable Apply Button
                        const btn = document.getElementById('applyBtn');
                        btn.disabled = true;
                        btn.innerText = "Cooldown Active";
                        
                        // Show Error Box
                        document.getElementById('cooldownMsg').style.display = 'block';
                        document.getElementById('timeLeft').innerText = Math.ceil((waitTime - diff)/60000) + " minutes";
                    }
                }
            });
        }

        // 3. SECURE APPLY FUNCTION (With Delay & Re-check)
        window.applyTask = () => {
            const btn = document.getElementById('applyBtn');
            const user = auth.currentUser;

            // A. Visual Feedback (Loading...)
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking Eligibility...';

            // B. Artificial Delay (3 Seconds) to prevent spam
            setTimeout(() => {
                
                // C. Final Database Check before pushing
                get(child(ref(db), `users/${user.uid}/lastTaskTime`)).then((snap) => {
                    const lastTime = snap.val() || 0;
                    const diff = Date.now() - lastTime;
                    const waitTime = 7200000; // 2 Hours

                    if (diff >= waitTime) {
                        // Success: Create Task
                        push(ref(db, 'tasks'), { 
                            uid: user.uid, 
                            status: 'pending', 
                            timestamp: Date.now() 
                        });
                        
                        // Update User's Last Task Time
                        update(ref(db, `users/${user.uid}`), { lastTaskTime: Date.now() });
                        
                        // Note: UI will auto-update via onValue listener
                    } else {
                        // Failed: Show Alert
                        alert("You cannot apply yet! Please wait for the cooldown.");
                        window.location.reload(); // Refresh to show timer
                    }
                });

            }, 3000); // 3000ms = 3 Seconds Delay
        }

        // --- Helper Functions Below ---

        window.copyText = (id) => {
            const text = document.getElementById(id).innerText;
            if(text) { navigator.clipboard.writeText(text); alert("Copied!"); }
        }

        window.handleFileSelect = (inputId, labelId) => {
            const input = document.getElementById(inputId);
            if(input.files && input.files[0]) {
                const label = document.getElementById(labelId);
                label.innerHTML = '<i class="fas fa-check-circle"></i> File Selected âœ…';
                label.classList.add('uploaded');
            }
        }

        function showTaskUI(task) {
            document.getElementById('applySection').style.display = 'none';
            document.getElementById('taskSection').style.display = 'block';
            const msg = document.getElementById('statusMsg');
            
            if(task.status === 'pending') {
                msg.innerText = "Request Sent! Please wait for Admin...";
                document.getElementById('adminDetails').style.display = 'none';
            } else if (task.status === 'assigned') {
                msg.innerText = "Task Details Received. Complete it now!";
                document.getElementById('adminDetails').style.display = 'block';
                document.getElementById('t_fname').innerText = task.data.fname;
                document.getElementById('t_lname').innerText = task.data.lname;
                document.getElementById('t_gmail').innerText = task.data.gmail;
                document.getElementById('t_pass').innerText = task.data.password;
                document.getElementById('t_rec').innerText = task.data.recovery;
                document.getElementById('t_time').innerText = task.data.timeLimit;
            } else if (task.status === 'submitted') {
                msg.innerText = "Proof Submitted! Review in progress (24h).";
                document.getElementById('adminDetails').style.display = 'none';
            }
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        window.submitTask = async () => {
            const btn = document.getElementById('submitBtn');
            btn.disabled = true; 
            btn.innerText = "Uploading...";
            
            const f1 = document.getElementById('ss1').files[0];
            const f2 = document.getElementById('ss2').files[0];

            if(!f1 || !f2) {
                alert("Please upload BOTH screenshots!");
                btn.disabled = false; btn.innerText = "SUBMIT PROOF";
                return;
            }
            
            try {
                const img1 = await toBase64(f1);
                const img2 = await toBase64(f2);
                update(ref(db, `tasks/${currentTaskId}`), { status: 'submitted', ss1: img1, ss2: img2 });
                alert("Submission Successful!");
            } catch(e) {
                alert("Error uploading images. Try again.");
                btn.disabled = false; btn.innerText = "SUBMIT PROOF";
            }
        }
    </script>
</body>
</html>
