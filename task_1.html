<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Task 1 - Gmail Creation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Shared Premium CSS */
        body { background: #0f0c29; color: white; font-family: 'Poppins', sans-serif; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); }
        h2 { text-align: center; color: #ffd700; }
        .status-box { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        button { width: 100%; padding: 12px; background: #ffd700; border: none; font-weight: bold; cursor: pointer; border-radius: 5px; margin-top: 10px; }
        button:disabled { background: #555; cursor: not-allowed; }
        .details-box { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 5px; margin: 10px 0; font-family: monospace; }
        input { width: 95%; padding: 10px; margin: 5px 0; background: transparent; border: 1px solid #555; color: white; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Gmail Task</h2>
        <div id="statusArea" class="status-box">Loading status...</div>
        
        <!-- Step 1: Apply -->
        <div id="applySection" style="display:none;">
            <p>Create a Gmail based on Admin instructions.</p>
            <button id="btnApply" onclick="applyForTask()">APPLY FOR TASK</button>
            <p id="timer" style="color:red; text-align:center;"></p>
        </div>

        <!-- Step 2: Waiting for Admin -->
        <div id="waitingSection" style="display:none;">
            <h3>Waiting for Admin...</h3>
            <p>The admin has received your request. Please wait for details to appear below.</p>
        </div>

        <!-- Step 3: View Task & Submit -->
        <div id="submitSection" style="display:none;">
            <h3>Task Details (From Admin)</h3>
            <div id="adminInstructions" class="details-box"></div>
            <hr>
            <h3>Submit Your Work</h3>
            <p>Create the Gmail exactly as requested and submit details here:</p>
            <input type="text" id="subEmail" placeholder="Created Email">
            <input type="text" id="subPass" placeholder="Password Used">
            <button onclick="submitTask()">SUBMIT TASK</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
        
        // CONFIG
        const firebaseConfig = { apiKey: "AIzaSyB2YLhAvSF12ZZx7LSnbqcCjtS2_8QLt4o", authDomain: "task-f6078.firebaseapp.com", databaseURL: "https://task-f6078-default-rtdb.firebaseio.com", projectId: "task-f6078", storageBucket: "task-f6078.firebasestorage.app", messagingSenderId: "887907470692", appId: "1:887907470692:web:c4142ac9573e19d29d3e71" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                checkTaskStatus();
            } else { window.location.href = "register_login.html"; }
        });

        function checkTaskStatus() {
            const taskRef = ref(db, 'task_requests/' + currentUser.uid);
            onValue(taskRef, (snapshot) => {
                const data = snapshot.val();
                const uiStatus = document.getElementById('statusArea');
                
                document.getElementById('applySection').style.display = 'none';
                document.getElementById('waitingSection').style.display = 'none';
                document.getElementById('submitSection').style.display = 'none';

                if (!data) {
                    // Check cooldown logic here from user profile (skipped for brevity, assuming idle)
                    uiStatus.innerText = "Status: Idle";
                    document.getElementById('applySection').style.display = 'block';
                } else if (data.status === 'requested') {
                    uiStatus.innerText = "Status: Pending Admin Approval";
                    document.getElementById('waitingSection').style.display = 'block';
                } else if (data.status === 'assigned') {
                    uiStatus.innerText = "Status: Task Assigned";
                    document.getElementById('submitSection').style.display = 'block';
                    document.getElementById('adminInstructions').innerHTML = 
                        `First Name: ${data.adminData.firstName}<br>
                         Last Name: ${data.adminData.lastName}<br>
                         Recovery: ${data.adminData.recovery}<br>
                         Req. Email: ${data.adminData.reqEmail}<br>
                         Req. Pass: ${data.adminData.reqPass}`;
                } else if (data.status === 'submitted') {
                    uiStatus.innerText = "Status: Under Review";
                }
            });
        }

        window.applyForTask = () => {
            const btn = document.getElementById('btnApply');
            const timerDisplay = document.getElementById('timer');
            btn.disabled = true;
            let count = 5;
            
            const interval = setInterval(() => {
                count--;
                timerDisplay.innerText = `Applying in ${count}...`;
                if(count <= 0) {
                    clearInterval(interval);
                    // Send Request
                    set(ref(db, 'task_requests/' + currentUser.uid), {
                        status: 'requested',
                        userPhone: currentUser.email.split('@')[0], // Using phone from fake email
                        timestamp: Date.now()
                    });
                }
            }, 1000);
        };

        window.submitTask = () => {
            const subEmail = document.getElementById('subEmail').value;
            const subPass = document.getElementById('subPass').value;
            
            if(!subEmail || !subPass) return alert("Fill all fields");

            update(ref(db, 'task_requests/' + currentUser.uid), {
                status: 'submitted',
                submission: {
                    email: subEmail,
                    password: subPass
                }
            });
            alert("Submitted! Wait for admin check.");
        }
    </script>
</body>
</html>
