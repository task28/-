<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Withdraw - Premium</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* CSS SAME AS BEFORE */
        body { background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); color: white; font-family: 'Poppins', sans-serif; padding: 20px; min-height: 100vh; }
        .card { background: rgba(255,255,255,0.05); padding: 25px; border-radius: 15px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h3 { margin-top: 0; color: #ffd700; }
        select, input, button { width: 100%; padding: 15px; margin-top: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; font-size: 16px; box-sizing: border-box; }
        select:focus, input:focus { outline: none; border-color: #ffd700; }
        button { background: linear-gradient(45deg, #ffd700, #ff8c00); color: black; font-weight: bold; cursor: pointer; border: none; transition: 0.3s; }
        button:hover { transform: scale(1.02); box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
        .history-item { border-bottom: 1px solid rgba(255,255,255,0.1); padding: 15px 0; display: flex; justify-content: space-between; align-items: center; }
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .status-pending { background: rgba(255, 165, 0, 0.2); color: orange; }
        .status-success { background: rgba(0, 255, 0, 0.2); color: lime; }
        .status-rejected { background: rgba(255, 0, 0, 0.2); color: red; }
    </style>
</head>
<body>

    <!-- Balance Display -->
    <div class="card" style="text-align: center;">
        <i class="fas fa-wallet" style="font-size: 2rem; color: #ffd700; margin-bottom: 10px;"></i>
        <div style="font-size: 0.9rem; opacity: 0.7;">Current Balance</div>
        <h2 style="margin: 5px 0; color: #fff;" id="myCurrentBal">0 TK</h2>
        <div style="font-size: 0.8rem; margin-top: 10px; color: #aaa;">Total Withdrawn: <span id="totalWith">0</span> TK</div>
    </div>

    <!-- Request Form -->
    <div class="card">
        <h3>Request Withdrawal</h3>
        <select id="method" onchange="updatePlaceholder()">
            <option value="bkash">Bkash</option>
            <option value="nagad">Nagad</option>
            <option value="usdt">USDT (TRC20)</option>
            <option value="shopping28">Shopping28 ID</option>
        </select>
        <input type="number" id="amount" placeholder="Amount (TK)">
        <input type="text" id="wallet" placeholder="Enter Wallet Number">
        <button onclick="requestWithdraw()">CONFIRM WITHDRAW</button>
        <p id="limitMsg" style="text-align:center; font-size: 0.8rem; color: #ffd700; margin-top: 10px;"></p>
    </div>

    <!-- History -->
    <div class="card">
        <h3><i class="fas fa-history"></i> Withdrawal History</h3>
        <div id="historyList">
            <div style="text-align:center; opacity:0.5;">Loading history...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        // ADDED 'get' and 'update' here
        import { getDatabase, ref, push, onValue, serverTimestamp, get, update } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
        
        const firebaseConfig = { apiKey: "AIzaSyB2YLhAvSF12ZZx7LSnbqcCjtS2_8QLt4o", authDomain: "task-f6078.firebaseapp.com", databaseURL: "https://task-f6078-default-rtdb.firebaseio.com", projectId: "task-f6078", storageBucket: "task-f6078.firebasestorage.app", messagingSenderId: "887907470692", appId: "1:887907470692:web:c4142ac9573e19d29d3e71" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let userBalance = 0;
        let minWithdrawLimit = 50; // Default fallback

        // Update placeholder
        window.updatePlaceholder = () => {
            const method = document.getElementById('method').value;
            const input = document.getElementById('wallet');
            if(method === 'shopping28') input.placeholder = "Enter Shopping28 User ID";
            else if (method === 'usdt') input.placeholder = "Enter TRC20 Address";
            else input.placeholder = "Enter " + method.charAt(0).toUpperCase() + method.slice(1) + " Number";
        }

        auth.onAuthStateChanged(user => {
            if(user) {
                // 1. Listen to Balance
                onValue(ref(db, 'users/' + user.uid), snap => {
                    const data = snap.val();
                    userBalance = data.balance || 0;
                    document.getElementById('myCurrentBal').innerText = userBalance + " TK";
                });

                // 2. Get Admin Min Limit
                get(ref(db, 'settings/min_withdrawal')).then(snap => {
                    if(snap.exists()) {
                        minWithdrawLimit = parseInt(snap.val());
                        document.getElementById('limitMsg').innerText = `Minimum withdrawal limit: ${minWithdrawLimit} TK`;
                    }
                });

                loadHistory(user.uid);
            } else {
                window.location.href = "register_login.html";
            }
        });

        // --- MAIN FIX IS HERE ---
        window.requestWithdraw = async () => {
            const user = auth.currentUser;
            const amountInput = document.getElementById('amount');
            const walletInput = document.getElementById('wallet');
            const method = document.getElementById('method').value;
            
            const amount = parseInt(amountInput.value);
            const wallet = walletInput.value;

            // Validation 1: Empty Fields
            if(!amount || !wallet) return alert("Please fill all fields");

            // Validation 2: Check Admin Limit
            if(amount < minWithdrawLimit) {
                return alert(`Minimum withdrawal amount is ${minWithdrawLimit} TK`);
            }

            // Validation 3: Check User Balance (Fix for "Balance chara withdraw")
            if(amount > userBalance) {
                return alert("Insufficient Balance! You have only " + userBalance + " TK.");
            }

            const btn = document.querySelector('button');
            btn.innerHTML = "Processing...";
            btn.disabled = true;

            try {
                // Step 1: Deduct Balance Immediately (To prevent double withdraw)
                const newBal = userBalance - amount;
                await update(ref(db, 'users/' + user.uid), {
                    balance: newBal
                });

                // Step 2: Create Request
                await push(ref(db, 'withdrawals'), {
                    uid: user.uid,
                    amount: amount,
                    method: method,
                    wallet: wallet,
                    status: 'pending',
                    timestamp: serverTimestamp()
                });

                alert("Withdrawal Request Sent Successfully!");
                amountInput.value = "";
                walletInput.value = "";
            } catch (error) {
                alert("Error: " + error.message);
            }

            btn.innerHTML = "CONFIRM WITHDRAW";
            btn.disabled = false;
        };

        function loadHistory(uid) {
            onValue(ref(db, 'withdrawals'), snapshot => {
                const list = document.getElementById('historyList');
                list.innerHTML = "";
                let myWithdraws = [];
                let total = 0;
                
                snapshot.forEach(child => {
                    const w = child.val();
                    if(w.uid === uid) {
                        myWithdraws.push(w);
                        if(w.status === 'success') total += parseInt(w.amount);
                    }
                });

                document.getElementById('totalWith').innerText = total;

                if(myWithdraws.length === 0) {
                    list.innerHTML = "<div style='text-align:center; opacity:0.5;'>No history found.</div>";
                    return;
                }

                myWithdraws.reverse().slice(0,5).forEach(w => {
                    let badgeClass = 'status-pending';
                    if(w.status === 'success') badgeClass = 'status-success';
                    if(w.status === 'rejected') badgeClass = 'status-rejected';
                    let methodName = w.method === 'shopping28' ? 'Shopping28' : w.method.toUpperCase();

                    list.innerHTML += `
                    <div class="history-item">
                        <div>
                            <div style="font-weight:bold; color:#fff;">${methodName}</div>
                            <div style="font-size:12px; opacity:0.6;">${w.wallet}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="color:#ffd700; font-weight:bold;">${w.amount} TK</div>
                            <span class="status-badge ${badgeClass}">${w.status.toUpperCase()}</span>
                        </div>
                    </div>`;
                });
            });
        }
    </script>
</body>
</html>
